# å¤‡å¿˜å½•APIåº”ç”¨éƒ¨ç½²è¯´æ˜

## ğŸ“‹ entrypoint.sh æ–‡ä»¶ä½œç”¨

`entrypoint.sh` æ˜¯åº”ç”¨çš„**å¯åŠ¨è„šæœ¬**ï¼Œä¸»è¦åŠŸèƒ½ï¼š

1. **ç¯å¢ƒæ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«å¼€å‘ç¯å¢ƒæˆ–ç”Ÿäº§ç¯å¢ƒ
2. **ç¯å¢ƒå˜é‡è®¾ç½®**ï¼šè®¾ç½®ç›¸åº”çš„ NODE_ENV ç¯å¢ƒå˜é‡
3. **åº”ç”¨å¯åŠ¨**ï¼šå¯åŠ¨å¤‡å¿˜å½•APIæœåŠ¡å™¨ (app.js)

## ğŸš€ éƒ¨ç½²å’Œå¯åŠ¨æ–¹å¼

### 1. å¼€å‘ç¯å¢ƒå¯åŠ¨
```bash
# æ–¹å¼1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬
./entrypoint.sh development
# æˆ–è€…
./entrypoint.sh dev

# æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨npm
npm run dev

# æ–¹å¼3ï¼šç›´æ¥ä½¿ç”¨node
NODE_ENV=development node app.js
```

### 2. ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
```bash
# æ–¹å¼1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
./entrypoint.sh production
# æˆ–è€…
./entrypoint.sh prod

# æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨npm
npm start

# æ–¹å¼3ï¼šç›´æ¥ä½¿ç”¨node
NODE_ENV=production node app.js
```

### 3. é»˜è®¤å¯åŠ¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
```bash
# ä¸æŒ‡å®šå‚æ•°æ—¶ï¼Œé»˜è®¤ä¸ºå¼€å‘ç¯å¢ƒ
./entrypoint.sh
```

## ğŸ”§ éƒ¨ç½²å‰å‡†å¤‡

### 1. ç¡®ä¿æ–‡ä»¶æƒé™
```bash
chmod +x entrypoint.sh
```

### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡
æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„é…ç½®ï¼š
```env
PORT=3000
DB_HOST=test-db-mysql.ns-i0ev2cvd.svc
DB_PORT=3306
DB_USER=root
DB_PASSWORD=j949trs7
DB_NAME=memo_app
NODE_ENV=development
```

## ğŸŒ Devboxäº‘æœåŠ¡å™¨éƒ¨ç½²

### 1. å½“å‰æœåŠ¡å™¨ä¿¡æ¯
- **æœåŠ¡å™¨åœ°å€**: https://vgsarkerfnri.sealosbja.site
- **å†…éƒ¨ç«¯å£**: 3000
- **æ•°æ®åº“**: MySQL (å·²é…ç½®)

### 2. éƒ¨ç½²æ­¥éª¤

#### æ­¥éª¤1ï¼šå¯åŠ¨åº”ç”¨
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
./entrypoint.sh production
```

#### æ­¥éª¤2ï¼šéªŒè¯æœåŠ¡
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:3000

# æ£€æŸ¥APIæ¥å£
curl http://localhost:3000/api/memos
```

#### æ­¥éª¤3ï¼šå¤–ç½‘è®¿é—®æµ‹è¯•
```bash
# æµ‹è¯•å¤–ç½‘è®¿é—®
curl https://vgsarkerfnri.sealosbja.site
curl https://vgsarkerfnri.sealosbja.site/api/memos
```

### 3. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

#### ä½¿ç”¨PM2è¿›ç¨‹ç®¡ç†ï¼ˆæ¨èï¼‰
```bash
# å®‰è£…PM2
npm install -g pm2

# åˆ›å»ºPM2é…ç½®æ–‡ä»¶
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'memo-api',
    script: './entrypoint.sh',
    args: 'production',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
EOF

# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs memo-api

# åœæ­¢åº”ç”¨
pm2 stop memo-api

# é‡å¯åº”ç”¨
pm2 restart memo-api
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨çŠ¶æ€æ£€æŸ¥
```bash
# æ£€æŸ¥è¿›ç¨‹
ps aux | grep node

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 3000

# æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
curl http://localhost:3000
```

### 2. æ—¥å¿—æŸ¥çœ‹
```bash
# å¦‚æœä½¿ç”¨PM2
pm2 logs memo-api

# å¦‚æœç›´æ¥è¿è¡Œ
# æ—¥å¿—ä¼šç›´æ¥è¾“å‡ºåˆ°ç»ˆç«¯
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ç¯å¢ƒå˜é‡å®‰å…¨
- ç”Ÿäº§ç¯å¢ƒä¸­ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ç®¡ç†æ•æ„Ÿæ•°æ®

### 2. æ•°æ®åº“å®‰å…¨
- ç¡®ä¿æ•°æ®åº“å¯†ç å®‰å…¨
- é™åˆ¶æ•°æ®åº“è®¿é—®æƒé™

## ğŸš¨ æ•…éšœæ’é™¤

### 1. ç«¯å£å ç”¨é—®é¢˜
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :3000

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 <PID>
```

### 2. æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
node -e "
const mysql = require('mysql2/promise');
mysql.createConnection({
  host: 'test-db-mysql.ns-i0ev2cvd.svc',
  port: 3306,
  user: 'root',
  password: 'j949trs7'
}).then(() => console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ')).catch(console.error);
"
```

### 3. æƒé™é—®é¢˜
```bash
# ç¡®ä¿å¯åŠ¨è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x entrypoint.sh

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la entrypoint.sh
```

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ–‡ä»¶æƒé™è®¾ç½®æ­£ç¡® (`chmod +x entrypoint.sh`)
- [ ] ä¾èµ–å®‰è£…å®Œæˆ (`npm install`)
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡® (`.env` æ–‡ä»¶)
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] å¯åŠ¨è„šæœ¬æµ‹è¯•é€šè¿‡
- [ ] APIæ¥å£æµ‹è¯•é€šè¿‡
- [ ] å¤–ç½‘è®¿é—®æµ‹è¯•é€šè¿‡

## ğŸ¯ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

```bash
# ä¸€é”®éƒ¨ç½²è„šæœ¬
#!/bin/bash
echo "å¼€å§‹éƒ¨ç½²å¤‡å¿˜å½•APIåº”ç”¨..."

# 1. è®¾ç½®æƒé™
chmod +x entrypoint.sh

# 2. å®‰è£…ä¾èµ–
npm install

# 3. å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
./entrypoint.sh production

echo "éƒ¨ç½²å®Œæˆï¼"
echo "è®¿é—®åœ°å€: https://vgsarkerfnri.sealosbja.site"
```

ä¿å­˜ä¸º `deploy.sh` å¹¶æ‰§è¡Œï¼š
```bash
chmod +x deploy.sh
./deploy.sh
```
