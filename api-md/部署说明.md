# 备忘录API应用部署说明

## 📋 entrypoint.sh 文件作用

`entrypoint.sh` 是应用的**启动脚本**，主要功能：

1. **环境检测**：自动识别开发环境或生产环境
2. **环境变量设置**：设置相应的 NODE_ENV 环境变量
3. **应用启动**：启动备忘录API服务器 (app.js)

## 🚀 部署和启动方式

### 1. 开发环境启动
```bash
# 方式1：使用启动脚本
./entrypoint.sh development
# 或者
./entrypoint.sh dev

# 方式2：直接使用npm
npm run dev

# 方式3：直接使用node
NODE_ENV=development node app.js
```

### 2. 生产环境启动
```bash
# 方式1：使用启动脚本（推荐）
./entrypoint.sh production
# 或者
./entrypoint.sh prod

# 方式2：直接使用npm
npm start

# 方式3：直接使用node
NODE_ENV=production node app.js
```

### 3. 默认启动（开发环境）
```bash
# 不指定参数时，默认为开发环境
./entrypoint.sh
```

## 🔧 部署前准备

### 1. 确保文件权限
```bash
chmod +x entrypoint.sh
```

### 2. 安装依赖
```bash
npm install
```

### 3. 配置环境变量
检查 `.env` 文件中的配置：
```env
PORT=3000
DB_HOST=test-db-mysql.ns-i0ev2cvd.svc
DB_PORT=3306
DB_USER=root
DB_PASSWORD=j949trs7
DB_NAME=memo_app
NODE_ENV=development
```

## 🌐 Devbox云服务器部署

### 1. 当前服务器信息
- **服务器地址**: https://vgsarkerfnri.sealosbja.site
- **内部端口**: 3000
- **数据库**: MySQL (已配置)

### 2. 部署步骤

#### 步骤1：启动应用
```bash
# 在项目根目录执行
./entrypoint.sh production
```

#### 步骤2：验证服务
```bash
# 检查服务状态
curl http://localhost:3000

# 检查API接口
curl http://localhost:3000/api/memos
```

#### 步骤3：外网访问测试
```bash
# 测试外网访问
curl https://vgsarkerfnri.sealosbja.site
curl https://vgsarkerfnri.sealosbja.site/api/memos
```

### 3. 生产环境优化建议

#### 使用PM2进程管理（推荐）
```bash
# 安装PM2
npm install -g pm2

# 创建PM2配置文件
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'memo-api',
    script: './entrypoint.sh',
    args: 'production',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
EOF

# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs memo-api

# 停止应用
pm2 stop memo-api

# 重启应用
pm2 restart memo-api
```

## 📊 监控和日志

### 1. 应用状态检查
```bash
# 检查进程
ps aux | grep node

# 检查端口占用
netstat -tlnp | grep 3000

# 检查应用健康状态
curl http://localhost:3000
```

### 2. 日志查看
```bash
# 如果使用PM2
pm2 logs memo-api

# 如果直接运行
# 日志会直接输出到终端
```

## 🔒 安全配置

### 1. 环境变量安全
- 生产环境中不要在代码中硬编码敏感信息
- 使用环境变量或配置文件管理敏感数据

### 2. 数据库安全
- 确保数据库密码安全
- 限制数据库访问权限

## 🚨 故障排除

### 1. 端口占用问题
```bash
# 查找占用端口的进程
lsof -i :3000

# 杀死占用进程
kill -9 <PID>
```

### 2. 数据库连接问题
```bash
# 测试数据库连接
node -e "
const mysql = require('mysql2/promise');
mysql.createConnection({
  host: 'test-db-mysql.ns-i0ev2cvd.svc',
  port: 3306,
  user: 'root',
  password: 'j949trs7'
}).then(() => console.log('数据库连接成功')).catch(console.error);
"
```

### 3. 权限问题
```bash
# 确保启动脚本有执行权限
chmod +x entrypoint.sh

# 检查文件权限
ls -la entrypoint.sh
```

## 📝 部署检查清单

- [ ] 文件权限设置正确 (`chmod +x entrypoint.sh`)
- [ ] 依赖安装完成 (`npm install`)
- [ ] 环境变量配置正确 (`.env` 文件)
- [ ] 数据库连接正常
- [ ] 启动脚本测试通过
- [ ] API接口测试通过
- [ ] 外网访问测试通过

## 🎯 快速部署命令

```bash
# 一键部署脚本
#!/bin/bash
echo "开始部署备忘录API应用..."

# 1. 设置权限
chmod +x entrypoint.sh

# 2. 安装依赖
npm install

# 3. 启动生产环境
./entrypoint.sh production

echo "部署完成！"
echo "访问地址: https://vgsarkerfnri.sealosbja.site"
```

保存为 `deploy.sh` 并执行：
```bash
chmod +x deploy.sh
./deploy.sh
```
